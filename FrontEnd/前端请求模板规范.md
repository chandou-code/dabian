# 校园失物招领系统 - 前端请求模板规范

## 1. 基础请求工具

### 1.1 请求工具概述

项目使用封装的 `request` 函数进行网络请求，支持GET、POST、PUT、DELETE等HTTP方法，自动处理token认证、请求头设置、响应处理和错误提示。

### 1.2 核心请求函数

```javascript
// 基础请求函数
export const request = (options) => {
  // 配置处理...
  return new Promise((resolve, reject) => {
    uni.request({
      // 请求配置
      success: (res) => {
        // 响应处理
      },
      fail: (err) => {
        // 错误处理
      }
    })
  })
}

// 便捷请求方法
export const get = (url, params, options = {}) => { /* ... */ }
export const post = (url, data, options = {}) => { /* ... */ }
export const put = (url, data, options = {}) => { /* ... */ }
export const del = (url, options = {}) => { /* ... */ }
```

### 1.3 请求配置选项

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| url | string | 是 | - | 请求路径，自动拼接baseURL |
| method | string | 否 | GET | HTTP请求方法 |
| data | object | 否 | {} | 请求体数据（POST/PUT） |
| params | object | 否 | {} | 查询参数（GET） |
| header | object | 否 | {} | 自定义请求头 |

### 1.4 响应数据格式

```javascript
{
  "code": 200,        // 业务状态码
  "msg": "成功",       // 响应消息
  "data": { ... }      // 响应数据
}
```

## 2. 增删改查（CRUD）请求模板

### 2.1 查询（GET）

#### 基础查询
```javascript
import { get } from '@/api/request'

// 获取列表数据
export const getItems = (params) => {
  return get('/items/list', params)
}

// 使用示例
async fetchItems() {
  try {
    const params = {
      page: 1,
      size: 10,
      keyword: '手机'
    }
    const response = await getItems(params)
    this.items = response.data
  } catch (error) {
    console.error('获取列表失败:', error)
  }
}
```

#### 详情查询
```javascript
// 获取单条数据
export const getItemDetail = (itemId) => {
  return get(`/items/${itemId}`)
}

// 使用示例
async fetchItemDetail() {
  try {
    const response = await getItemDetail(this.itemId)
    this.item = response.data
  } catch (error) {
    console.error('获取详情失败:', error)
  }
}
```

### 2.2 新增（POST）

#### 基础新增
```javascript
import { post } from '@/api/request'

// 新增数据
export const createItem = (itemData) => {
  return post('/items', itemData)
}

// 使用示例
async addItem() {
  try {
    const itemData = {
      title: '丢失的手机',
      description: '黑色iPhone 12，带有保护壳',
      location: '图书馆',
      contact: '13800138000'
    }
    const response = await createItem(itemData)
    uni.showToast({ title: '新增成功' })
    this.resetForm()
  } catch (error) {
    console.error('新增失败:', error)
  }
}
```

#### 文件上传
```javascript
// 文件上传
export const uploadFile = (filePath) => {
  return new Promise((resolve, reject) => {
    uni.uploadFile({
      url: 'http://localhost:18080/api/upload',
      filePath: filePath,
      name: 'file',
      header: {
        'Authorization': `Bearer ${uni.getStorageSync('token')}`
      },
      success: (res) => {
        const data = JSON.parse(res.data)
        if (data.code === 200) {
          resolve(data)
        } else {
          reject(data)
        }
      },
      fail: (err) => {
        reject(err)
      }
    })
  })
}

// 使用示例
async handleUpload() {
  try {
    const [file] = await uni.chooseImage({
      count: 1,
      sizeType: ['compressed']
    })
    
    const response = await uploadFile(file.tempFilePaths[0])
    this.imageUrl = response.data.url
    uni.showToast({ title: '上传成功' })
  } catch (error) {
    console.error('上传失败:', error)
  }
}
```

### 2.3 更新（PUT）

#### 基础更新
```javascript
import { put } from '@/api/request'

// 更新数据
export const updateItem = (itemId, itemData) => {
  return put(`/items/${itemId}`, itemData)
}

// 使用示例
async updateItemInfo() {
  try {
    const itemData = {
      title: '更新后的标题',
      description: '更新后的描述'
    }
    const response = await updateItem(this.itemId, itemData)
    uni.showToast({ title: '更新成功' })
    this.fetchItemDetail() // 刷新数据
  } catch (error) {
    console.error('更新失败:', error)
  }
}
```

#### 部分更新
```javascript
// 部分更新
export const patchItem = (itemId, partialData) => {
  return put(`/items/${itemId}/patch`, partialData)
}

// 使用示例
async updateItemStatus() {
  try {
    const response = await patchItem(this.itemId, {
      status: 'approved'
    })
    uni.showToast({ title: '状态更新成功' })
  } catch (error) {
    console.error('状态更新失败:', error)
  }
}
```

### 2.4 删除（DELETE）

#### 单条删除
```javascript
import { del } from '@/api/request'

// 删除数据
export const deleteItem = (itemId) => {
  return del(`/items/${itemId}`)
}

// 使用示例
async removeItem() {
  try {
    await deleteItem(this.itemId)
    uni.showToast({ title: '删除成功' })
    this.fetchItems() // 刷新列表
  } catch (error) {
    console.error('删除失败:', error)
  }
}
```

#### 批量删除
```javascript
// 批量删除
export const batchDeleteItems = (itemIds) => {
  return del('/items/batch', {
    data: { ids: itemIds } // DELETE请求带请求体
  })
}

// 使用示例
async batchRemoveItems() {
  try {
    const selectedIds = this.selectedItems.map(item => item.id)
    await batchDeleteItems(selectedIds)
    uni.showToast({ title: '批量删除成功' })
    this.fetchItems() // 刷新列表
  } catch (error) {
    console.error('批量删除失败:', error)
  }
}
```

## 3. 常见请求场景

### 3.1 带条件的分页查询

```javascript
// 带条件的分页查询
export const getItemsByCondition = (params) => {
  return get('/items/query', params)
}

// 使用示例
async fetchItems() {
  try {
    const params = {
      page: this.currentPage,
      size: this.pageSize,
      keyword: this.searchQuery,
      status: this.selectedStatus,
      startTime: this.startDate,
      endTime: this.endDate
    }
    const response = await getItemsByCondition(params)
    this.items = response.data.list
    this.total = response.data.total
  } catch (error) {
    console.error('查询失败:', error)
  }
}
```

### 3.2 多条件组合查询

```javascript
// 多条件组合查询
export const searchItems = (searchParams) => {
  return post('/items/search', searchParams)
}

// 使用示例
async handleSearch() {
  try {
    const searchParams = {
      keyword: this.searchQuery,
      category: this.selectedCategory,
      location: this.selectedLocation,
      type: this.itemType,
      timeRange: this.selectedTimeRange
    }
    const response = await searchItems(searchParams)
    this.searchResults = response.data
  } catch (error) {
    console.error('搜索失败:', error)
  }
}
```

### 3.3 表单提交

```javascript
// 表单提交
export const submitForm = (formData) => {
  return post('/form/submit', formData)
}

// 使用示例
async onSubmit() {
  // 表单验证
  if (!this.form.title || !this.form.content) {
    uni.showToast({ title: '请填写必填项', icon: 'none' })
    return
  }
  
  try {
    await submitForm(this.form)
    uni.showToast({ title: '提交成功' })
    uni.navigateBack()
  } catch (error) {
    console.error('提交失败:', error)
  }
}
```

## 4. 请求拦截与响应处理

### 4.1 请求拦截

请求工具自动处理：
- token认证：从本地存储获取token并添加到请求头
- 请求URL拼接：自动拼接baseURL
- GET请求参数处理：将params转换为查询字符串
- 请求日志记录：打印请求配置

### 4.2 响应处理

响应自动处理：
- 响应日志记录：打印响应状态码、数据和数据类型
- 业务状态码检查：
  - `code === 200`：请求成功，返回响应数据
  - `code !== 200`：业务错误，显示错误消息并 reject
- HTTP状态码处理：
  - `401`：未授权，跳转到登录页
  - 其他错误：显示错误消息并 reject
- 网络错误：显示网络错误提示

## 5. 错误处理与调试

### 5.1 错误类型

| 错误类型 | 处理方式 |
|----------|----------|
| 业务错误 | 显示错误消息，打印错误信息 |
| 未授权 | 跳转到登录页，显示登录提示 |
| HTTP错误 | 显示状态码，打印错误信息 |
| 网络错误 | 显示网络错误提示，打印错误信息 |

### 5.2 调试技巧

1. **查看请求日志**：请求工具自动打印请求和响应日志
2. **使用uni.request的success/fail回调**：直接调试原始响应
3. **网络请求监控**：使用浏览器开发者工具的Network面板监控请求
4. **断点调试**：在关键位置添加断点，查看变量值

### 5.3 错误捕获

```javascript
// 全局错误捕获
export const withErrorHandling = async (fn, successMsg = '操作成功') => {
  try {
    const result = await fn()
    uni.showToast({ title: successMsg })
    return result
  } catch (error) {
    console.error('操作失败:', error)
    // 错误信息已经在request函数中处理
    return null
  }
}

// 使用示例
async handleOperation() {
  await withErrorHandling(async () => {
    await someApiCall()
  }, '操作成功')
}
```

## 6. 最佳实践

### 6.1 代码组织

1. **API模块化**：按功能模块组织API请求函数
2. **统一导出**：在index.js中统一导出所有API
3. **类型定义**：使用TypeScript或JSDoc定义请求和响应类型
4. **注释说明**：为每个API添加注释，说明用途、参数和返回值

### 6.2 性能优化

1. **请求防抖/节流**：避免频繁请求
2. **缓存机制**：对不常变化的数据进行缓存
3. **分页查询**：使用分页减少数据传输量
4. **批量操作**：使用批量API减少请求次数
5. **合理使用请求方法**：根据操作类型选择合适的HTTP方法

### 6.3 安全性

1. **token管理**：安全存储和使用token
2. **请求头验证**：所有请求都需要携带token
3. **数据验证**：前端和后端双重验证
4. **HTTPS**：生产环境使用HTTPS协议
5. **避免明文传输敏感数据**：使用加密方式传输敏感信息

### 6.4 可维护性

1. **统一的错误处理**：使用统一的错误处理机制
2. **清晰的命名**：API函数名应清晰表达其功能
3. **版本控制**：API URL中加入版本号
4. **文档化**：为API编写详细文档
5. **测试覆盖**：为API编写单元测试

## 7. 示例API模块

### 7.1 物品管理API示例

```javascript
// items.js - 物品管理API
import { get, post, put, del } from './request'

// 发布失物信息
export const publishLostItem = (itemInfo) => {
  return post('/items/lost-items', itemInfo)
}

// 发布招领信息
export const publishFoundItem = (itemInfo) => {
  return post('/items/found-items', itemInfo)
}

// 获取失物列表
export const getLostItems = (params) => {
  return get('/items/lost-items', params)
}

// 获取招领列表
export const getFoundItems = (params) => {
  return get('/items/found-items', params)
}

// 搜索物品
export const searchItems = (params) => {
  return get('/search/text', params)
}

// 获取失物详情
export const getLostItemDetail = (itemId) => {
  return get(`/items/lost-item/${itemId}`)
}

// 获取招领详情
export const getFoundItemDetail = (itemId) => {
  return get(`/items/found-item/${itemId}`)
}

// 更新物品信息
export const updateItem = (itemId, itemInfo) => {
  return put(`/items/items/${itemId}`, itemInfo)
}

// 删除物品信息
export const deleteItem = (itemId) => {
  return del(`/items/items/${itemId}`)
}
```

## 8. 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2026-01-03 | 初始版本，定义基础请求模板和CRUD规范 |

---

**说明：** 本前端请求模板规范用于指导校园失物招领系统前端开发，确保所有网络请求遵循统一的规范和最佳实践。开发过程中应严格遵循本规范，如有特殊需求需修改规范，需经过开发团队审核。