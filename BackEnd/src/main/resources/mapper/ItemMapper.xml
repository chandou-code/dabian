<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.campus.lostfound.mapper.ItemMapper">

    <select id="selectItemPage" resultType="com.campus.lostfound.entity.Item">
        SELECT * FROM items 
        WHERE deleted = 0
        <if test="type != null and type != '' and type != 'all'">
            AND type = #{type}
        </if>
        <if test="category != null and category != ''">
            AND category = #{category}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (item_name LIKE CONCAT('%', #{keyword}, '%') 
                 OR description LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="location != null and location != ''">
            AND location LIKE CONCAT('%', #{location}, '%')
        </if>
        <if test="submitterId != null">
            AND submitter_id = #{submitterId}
        </if>
        ORDER BY created_at DESC
    </select>

    <select id="selectUserStatistics" resultType="com.campus.lostfound.entity.Item">
        SELECT * FROM items 
        WHERE submitter_id = #{submitterId} AND deleted = 0
        ORDER BY created_at DESC
    </select>

    <select id="selectPendingItems" resultType="com.campus.lostfound.entity.Item">
        SELECT * FROM items 
        WHERE deleted = 0
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="type != null and type != '' and type != 'all'">
            AND type = #{type}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (item_name LIKE CONCAT('%', #{keyword}, '%') 
                 OR description LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY created_at ASC
    </select>

    <select id="searchItems" resultType="com.campus.lostfound.entity.Item">
        SELECT * FROM items 
        WHERE deleted = 0 AND status = 'approved'
        <if test="keyword != null and keyword != ''">
            AND (item_name LIKE CONCAT('%', #{keyword}, '%') 
                 OR description LIKE CONCAT('%', #{keyword}, '%')
                 OR location LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="type != null and type != '' and type != 'all'">
            AND type = #{type}
        </if>
        <if test="category != null and category != ''">
            AND category = #{category}
        </if>
        <if test="timeRange != null and timeRange != ''">
            <if test="timeRange == 'week'">
                AND created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
            </if>
            <if test="timeRange == 'month'">
                AND created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
            </if>
            <if test="timeRange == 'quarter'">
                AND created_at >= DATE_SUB(NOW(), INTERVAL 90 DAY)
            </if>
        </if>
        ORDER BY created_at DESC
    </select>

    <select id="selectRecentActivities" resultType="com.campus.lostfound.entity.Item">
        SELECT * FROM items 
        WHERE submitter_id = #{userId} AND deleted = 0
        ORDER BY created_at DESC
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <select id="selectRecommendedMatches" resultType="com.campus.lostfound.entity.Item">
        SELECT * FROM items 
        WHERE deleted = 0 
        AND status = 'approved'
        AND type != (SELECT type FROM items WHERE submitter_id = #{userId} AND deleted = 0 ORDER BY created_at DESC LIMIT 1)
        AND created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
        ORDER BY created_at DESC
        LIMIT 5
    </select>



    <select id="countItems" resultType="int">
        SELECT COUNT(*) FROM items 
        WHERE deleted = 0
        <if test="type != null and type != ''">
            AND type = #{type}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="submitterId != null">
            AND submitter_id = #{submitterId}
        </if>
    </select>

    <select id="selectDailyStatistics" resultType="com.campus.lostfound.entity.Item">
        SELECT 
            DATE(created_at) as date,
            SUM(CASE WHEN type = 'lost' THEN 1 ELSE 0 END) as lostCount,
            SUM(CASE WHEN type = 'found' THEN 1 ELSE 0 END) as foundCount,
            SUM(CASE WHEN status = 'claimed' THEN 1 ELSE 0 END) as recoveredCount
        FROM items 
        WHERE deleted = 0
        <if test="startDate != null">
            AND created_at >= #{startDate}
        </if>
        <if test="endDate != null">
            AND created_at &lt;= #{endDate}
        </if>
        GROUP BY DATE(created_at)
        ORDER BY date DESC
    </select>

    
    <select id="getCategoryStatistics" resultType="java.util.Map">
        SELECT 
            category,
            COUNT(*) as total,
            SUM(CASE WHEN status = 'claimed' THEN 1 ELSE 0 END) as recovered,
            ROUND(
                SUM(CASE WHEN status = 'claimed' THEN 1 ELSE 0 END) * 100.0 / 
                NULLIF(COUNT(*), 0), 
                1
            ) as recoveryRate,
            ROUND(
                AVG(
                    CASE 
                        WHEN status = 'claimed' AND created_at IS NOT NULL AND updated_at IS NOT NULL 
                        THEN DATEDIFF(updated_at, created_at)
                        ELSE NULL 
                    END
                ), 
                1
            ) as avgRecoveryTime
        FROM items 
        WHERE deleted = 0 AND category IS NOT NULL
        GROUP BY category
        ORDER BY total DESC
    </select>

    <!-- 更新浏览次数 -->
    <update id="updateViewCount">
        UPDATE items 
        SET view_count = IFNULL(view_count, 0) + 1 
        WHERE id = #{id} AND deleted = 0
    </update>

    
    <!-- 仪表板相关查询 -->
    
    <!-- 获取用户失物统计 -->
    <select id="getUserLostCount" resultType="int">
        SELECT COUNT(*) FROM items 
        WHERE submitter_id = #{userId} AND type = 'lost' AND deleted = 0
    </select>
    
    <!-- 获取用户招领统计 -->
    <select id="getUserFoundCount" resultType="int">
        SELECT COUNT(*) FROM items 
        WHERE submitter_id = #{userId} AND type = 'found' AND deleted = 0
    </select>
    
    <!-- 获取用户已找回物品统计 -->
    <select id="getUserRecoveredCount" resultType="int">
        SELECT COUNT(*) FROM items 
        WHERE submitter_id = #{userId} AND status = 'claimed' AND deleted = 0
    </select>
    
    <!-- 获取用户待处理信息统计（待审核的物品） -->
    <select id="getUserPendingCount" resultType="int">
        SELECT COUNT(*) FROM items 
        WHERE submitter_id = #{userId} AND status = 'pending' AND deleted = 0
    </select>
    
    <!-- 获取用户最近活动 -->
    <select id="selectUserRecentActivities" resultType="com.campus.lostfound.entity.Item">
        SELECT i.*, u.real_name as submitter_name, 
               CASE 
                   WHEN i.status = 'pending' THEN 'pending'
                   WHEN i.status = 'approved' THEN 'approved'
                   WHEN i.status = 'rejected' THEN 'rejected'
                   WHEN i.status = 'claimed' THEN 'recovered'
                   ELSE 'pending'
               END as activity_status
        FROM items i
        LEFT JOIN users u ON i.submitter_id = u.id
        WHERE i.submitter_id = #{userId} AND i.deleted = 0
        ORDER BY i.created_at DESC
        LIMIT #{limit}
    </select>
    
    <!-- 获取用户发布的所有物品 -->
    <select id="selectUserItems" resultType="com.campus.lostfound.entity.Item">
        SELECT i.*
        FROM items i
        WHERE i.submitter_id = #{userId} AND i.deleted = 0
        ORDER BY i.created_at DESC
    </select>
    
    <!-- 获取推荐匹配物品 -->
    <select id="selectRecommendedMatches" resultType="com.campus.lostfound.entity.Item">
        SELECT DISTINCT i.*,
               CASE 
                   WHEN EXISTS (
                       SELECT 1 FROM matches m 
                       WHERE (m.lost_item_id = i.id OR m.found_item_id = i.id)
                       AND m.status = 'pending'
                   ) THEN true
                   ELSE false
               END as has_pending_match
        FROM items i
        WHERE i.deleted = 0 
        AND i.status = 'approved'
        AND i.submitter_id != #{userId}
        AND (
            -- 找到用户可能感兴趣的物品（基于位置、类别等）
            i.location IN (SELECT DISTINCT location FROM items WHERE submitter_id = #{userId} AND deleted = 0)
            OR 
            i.category IN (SELECT DISTINCT category FROM items WHERE submitter_id = #{userId} AND deleted = 0)
        )
        ORDER BY i.created_at DESC
        LIMIT 10
    </select>
    
    <!-- 获取用户待审核数量 -->
    <select id="getUserPendingReviewCount" resultType="int">
        SELECT COUNT(*) FROM items 
        WHERE submitter_id = #{userId} AND status = 'pending' AND deleted = 0
    </select>
    
    <!-- 获取未读通知数量 -->
    <select id="getUserUnreadNotificationCount" resultType="int">
        SELECT COUNT(*) FROM notifications 
        WHERE user_id = #{userId} AND is_read = 0
    </select>
    
    <!-- 获取用户物品统计详情 -->
    <select id="getUserItemStats" resultType="map">
        SELECT 
            SUM(CASE WHEN type = 'lost' THEN 1 ELSE 0 END) as totalLost,
            SUM(CASE WHEN type = 'found' THEN 1 ELSE 0 END) as totalFound,
            SUM(CASE WHEN status = 'claimed' THEN 1 ELSE 0 END) as recovered,
            SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending
        FROM items 
        WHERE submitter_id = #{userId} AND deleted = 0
    </select>
    
    <!-- 获取全局失物数量 -->
    <select id="getGlobalLostCount" resultType="int">
        SELECT COUNT(*) FROM items 
        WHERE type = 'lost' AND deleted = 0
    </select>
    
    <!-- 获取全局招领数量 -->
    <select id="getGlobalFoundCount" resultType="int">
        SELECT COUNT(*) FROM items 
        WHERE type = 'found' AND deleted = 0
    </select>
    
    <!-- 获取全局已找回物品数量 -->
    <select id="getGlobalRecoveredCount" resultType="int">
        SELECT COUNT(*) FROM items 
        WHERE status = 'claimed' AND deleted = 0
    </select>
    
    <!-- 获取最新已审核物品列表 -->
    <select id="getRecentApprovedItems" resultType="map">
        SELECT 
            id,
            item_name as title,
            description,
            type,
            status,
            category,
            location,
            created_at as createTime,
            event_time as eventTime
        FROM items 
        WHERE status IN ('approved', 'claimed') AND deleted = 0
        ORDER BY created_at DESC 
        LIMIT #{limit}
    </select>

    <!-- 根据日期和类型统计物品数量 -->
    <select id="countItemsByDateAndType" resultType="int">
        SELECT COUNT(*) FROM items 
        WHERE deleted = 0 
        AND DATE(created_at) = #{date}
        AND type = #{type}
    </select>
    
    <!-- 根据日期统计已找回物品数量 -->
    <select id="countRecoveredItemsByDate" resultType="int">
        SELECT COUNT(*) FROM items 
        WHERE deleted = 0 
        AND DATE(created_at) = #{date}
        AND status = 'claimed'
    </select>

</mapper>